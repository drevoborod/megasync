# megasync

ОПИСАНИЕ

Утилита предназначена для регулярной синхронизации одной выбранной директории
с хранилищем на mega.co.nz. Передача содержимого директории происходит в виде
зашифрованного архива.


АЛГОРИТМ

Утилита ищет на mega.co.nz указанную директорию, а в ней - файлы архивов,
созданные в определённом формате: 'Prefix_DD_MM_YY_HH_mm_ss_platformid.7z".
Затем ищет аналогичные архивы в текущей
директории на локальном диске. Если архивы и на локальной машине, и на Меге
одинаковые, то утилита не делает ничего. Если где-то есть более новый архив,
то происходит синхронизация - самый новый архив копируется туда, где его нет:
- Если более новый файл на Меге, то он скачивается, распаковывается и его содержимым
заменяется указанная директория, при этом старая её версия переименовывается
в то же самое, но с постфиксом "_old".
- Если более новый файл на локальном диске, то он отправляется на Мегу.
Если ни там, ни там нет архивов, то указанная директория упаковывается
и архив отправляется на Мегу.
Если указан ключ командной строки "p", то указанная директория принудительно
упаковывается и архив отправляется на Мегу.


УСТАНОВКА

ОС: пока что - только Linux, но в дальнейшем будет адаптировано под разные платформы.

Для работы требуются следующие компоненты:
- python 3.4+ (www.python.org)
- 7zip (www.7-zip.org), точнее, консольная версия - "7z".
- megatools (https://github.com/megous/megatools)

Файл megasync.py требуется положить в ту директорию, в которой у вас будет находиться
директория для синхронизации (например, если в директории Documents есть директория Backup,
которую требуется синхронизировать, то утилита должна лежать в Documents).
Также в той же директории требуется создать файл 'megasync.cfg' со следующим содержанием:

----------start of file-----------
[DEFAULT]
## Пароль, с которым будет создаваться архив:
password=your_password

## Логин на Меге:
username=mail@example.com

## Название синхронизируемой директории на локальной машине.
## Также с этого же слова (префикса) будут начинаться имена создаваемых архивов.
## И это же слово будет использоваться для поиска (а если нет, то и создания)
## директории в корне хранилища Меги, где эти архивы будут храниться:
prefix=Testdir

## Произвольный идентификатор устройства, с которого запускается утилита.
## Необязателен, но удобен, если синхронизируемых устройств несколько
## и нужно знать, где именно был создан архив:
platform_id=someword

----------end of file------------

ЗАПУСК

Запуск производится в консоли, так как потребуется вводить пароль от Меги
в интерактивном режиме.
Просто запуск, для синхронизации:
$ ./megasync.py
Запуск для принудительной архивации и отправки заданной директории:
$ ./megasync.py p

Рекомендуется начать работу следующим образом: создать нужную директорию,
поместить рядом утилиту с файлом настроек и один раз запустить её, ничего
не создавая на Меге. Тогда на локальном диске будет создан первый архив,
а на Меге - директория, куда этот архив будет помещён. В дальнейшем можно будет
уже спокойно синхронизироваться с разных устройств.


ПРИМЕЧАНИЯ

На данный момент все создаваемые архивы остаются на Меге и локальном диске, пока
пользователь не удалит их вручную. Сделано специально в целях предосторожности,
так как приложение ещё сырое, могут быть ошибки. В дальнейшем планируется
реализовать такое поведение: при каждой синхронизации будут удаляться все архивы,
кроме трёх последних по времени.

Возможно, если у кого-то будут такие пожелания, в будущем будет опционально реализована
работа в полностью автономном режиме, т.е. без запроса пароля от Меги - он будет храниться
в конфигурационном файле.

!ВНИМАНИЕ!
На данный момент запускать утилиту можно только на довернных устройствах: во-первых,
вводимый пароль от Меги отбражается на экране; во-вторых, пароль от архивов хранится
в открытом виде в конфигурационном файле.
